<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="robots" content="noindex,nofollow" />
  <title>SecureOne | Banco Pichincha</title>

  <style>
    :root{
      --bg:#0b1f3a;
      --card:#0f2a4f;
      --text:#ffffff;
      --muted:rgba(255,255,255,.75);
      --border:rgba(255,255,255,.14);
      --shadow: 0 10px 30px rgba(0,0,0,.28);
      --danger:#b42318;
      --btn:#ffffff;
      --btnText:#0b1f3a;
      --soft:rgba(255,255,255,.06);
      --ok:#22c55e;
      --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1000px 600px at 50% -20%, rgba(255,255,255,.10), transparent 60%),
                  linear-gradient(180deg, var(--bg), #08162b);
      color:var(--text);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
    }
    .wrap{width:100%;max-width:520px}
    .brand{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
    .brand .title{font-weight:900;letter-spacing:.2px;font-size:18px;line-height:1.1}
    .brand .sub{font-size:12px;color:var(--muted);margin-top:3px}
    .badge{font-size:12px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;color:var(--muted);white-space:nowrap}
    .card{
      background: rgba(15,42,79,.92);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow: var(--shadow);
      padding:16px;
      backdrop-filter: blur(8px);
    }
    .agency{
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
      padding:12px;border:1px solid var(--border);border-radius:14px;
      background: rgba(255,255,255,.04);margin-bottom:12px
    }
    .lbl{font-size:12px;color:var(--muted)}
    .val{margin-top:2px;font-size:16px;font-weight:900;letter-spacing:.3px}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input{
      width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);
      background: rgba(255,255,255,.06);color:var(--text);outline:none;font-size:16px
    }
    input::placeholder{color:rgba(255,255,255,.45)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:14px}
    button{
      appearance:none;border:0;border-radius:14px;padding:14px 12px;font-size:16px;font-weight:900;
      cursor:pointer;transition: transform .05s ease, opacity .2s ease;
      display:flex;align-items:center;justify-content:center;gap:10px;user-select:none
    }
    button:active{transform: translateY(1px)}
    .btnOpen{background:var(--btn);color:var(--btnText)}
    .btnClose{background:rgba(255,255,255,.10);color:var(--text);border:1px solid var(--border)}
    .btnOpen[disabled],.btnClose[disabled]{opacity:.55;cursor:not-allowed;transform:none}
    .status{
      margin-top:12px;font-size:13px;color:var(--muted);min-height:18px;
      padding:12px;border-radius:14px;background:var(--soft);border:1px solid rgba(255,255,255,.08)
    }
    .status strong{color:var(--text)}
    .hint{margin-top:10px;font-size:12px;color:var(--muted);line-height:1.35}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);color:rgba(255,255,255,.85);font-size:12px
    }
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.ok{background:var(--ok)}
    .dot.warn{background:var(--warn)}

    /* Modal */
    .modalBack{
      position:fixed;inset:0;background:rgba(0,0,0,.55);
      display:none;align-items:center;justify-content:center;padding:16px
    }
    .modal{
      width:100%;max-width:520px;background:rgba(15,42,79,.98);
      border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);padding:16px
    }
    .modal h3{margin:0 0 6px;font-size:18px}
    .modal p{margin:0 0 14px;color:var(--muted);font-size:13px;line-height:1.4}
    .modal .actions{display:flex;gap:10px}
    .btnCancel{flex:1;background:rgba(255,255,255,.10);border:1px solid var(--border);color:var(--text)}
    .btnConfirm{flex:1;background:var(--danger);color:var(--text)}

    @media (max-width:420px){
      .grid{grid-template-columns:1fr}
      .badge{display:none}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="brand">
      <div>
        <div class="title">SecureOne</div>
        <div class="sub">Registro de Apertura / Cierre de Agencia</div>
      </div>
      <div class="badge" id="timeBadge">--:--</div>
    </div>

    <div class="card">
      <div class="agency">
        <div>
          <div class="lbl">Agencia</div>
          <div class="val" id="agencyVal">No detectada</div>
        </div>
        <div style="text-align:right">
          <div class="lbl">Estado</div>
          <div class="val" id="uiState" style="font-size:14px;font-weight:900;color:rgba(255,255,255,.85)">Listo</div>
        </div>
      </div>

      <div class="pill" id="corsHint">
        <span class="dot warn"></span>
        Env√≠o r√°pido (sin leer respuesta)
      </div>

      <label for="clave">Clave del d√≠a</label>
      <input id="clave" inputmode="numeric" autocomplete="one-time-code" placeholder="Ingresa la clave" />

      <div class="grid">
        <button class="btnOpen" id="btnOpen" type="button">APERTURA</button>
        <button class="btnClose" id="btnClose" type="button">CIERRE</button>
      </div>

      <div class="status" id="statusMsg">
        <strong>Listo.</strong> Ingresa la clave y registra la acci√≥n.
      </div>

      <div class="hint">
        Nota: por CORS, esta pantalla <strong>no puede validar</strong> la respuesta del flujo.
        La validaci√≥n real debe ocurrir en Power Automate (clave/horarios/estado).
      </div>
    </div>
  </div>

  <!-- Modal confirmaci√≥n cierre -->
  <div class="modalBack" id="modalBack" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal">
      <h3 id="modalTitle">Confirmar cierre</h3>
      <p id="modalText">¬øConfirmas registrar el <strong>CIERRE</strong> de esta agencia?</p>
      <div class="actions">
        <button class="btnCancel" id="btnCancel" type="button">Cancelar</button>
        <button class="btnConfirm" id="btnConfirm" type="button">Confirmar CIERRE</button>
      </div>
    </div>
  </div>

<script>
  // üîó MISMA URL (la que ya te funciona con no-cors)
  const FLOW_URL =
  "https://defaultf5b0d68214974db09019660035554e.72.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/58cb8760f3a441f4bfb1ada87e4bbac9/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=FjK6F5kKzWu8R8CBjHVMjnJp57WcCrwZ0plJYp2qti0";

  const elAgency = document.getElementById("agencyVal");
  const elClave  = document.getElementById("clave");
  const elStatus = document.getElementById("statusMsg");
  const elUIState= document.getElementById("uiState");
  const elTime   = document.getElementById("timeBadge");

  const btnOpen  = document.getElementById("btnOpen");
  const btnClose = document.getElementById("btnClose");

  const modalBack = document.getElementById("modalBack");
  const btnCancel = document.getElementById("btnCancel");
  const btnConfirm= document.getElementById("btnConfirm");
  const modalText = document.getElementById("modalText");

  // üìç Id agencia desde URL (mantenemos compatibilidad: loc/agencia/id)
  const params = new URLSearchParams(window.location.search);
  const locationId = (params.get("loc") || params.get("agencia") || params.get("id") || "DESCONOCIDO").trim();
  elAgency.textContent = locationId || "No detectada";

  function setBusy(isBusy){
    btnOpen.disabled = isBusy;
    btnClose.disabled = isBusy;
    elClave.disabled = isBusy;
    elUIState.textContent = isBusy ? "Enviando..." : "Listo";
  }

  function showMsg(html){
    elStatus.innerHTML = html;
  }

  function nowISO(){ return new Date().toISOString(); }

  // ‚úÖ Importante:
  // Con mode:no-cors NO podremos leer status/response.
  // Solo podemos ‚Äúenviar‚Äù y mostrar un mensaje de env√≠o.
  async function sendAction(action){
    const clave = (elClave.value || "").trim();

    if(!locationId || locationId === "DESCONOCIDO"){
      showMsg("<strong>Error.</strong> Falta el par√°metro de agencia en la URL (ej: ?loc=6).");
      return;
    }
    if(!clave){
      showMsg("<strong>Falta clave.</strong> Ingresa la clave del d√≠a.");
      elClave.focus();
      return;
    }

    setBusy(true);
    showMsg("<strong>Procesando‚Ä¶</strong> Enviando solicitud al sistema.");

    // Payload compatible: mantenemos locationId como antes + agregamos accion/clave
    const payload = {
      locationId: locationId,
      accion: action,     // "OPEN" | "CLOSE"
      clave: clave,
      clientTime: nowISO()
    };

    try{
      await fetch(FLOW_URL, {
        method: "POST",
        mode: "no-cors",
        // En no-cors, el navegador restringe headers; mejor NO forzar Content-Type
        body: JSON.stringify(payload)
      });

      // Si no hubo error de red, asumimos "enviado".
      showMsg("<strong>Enviado ‚úÖ</strong> La validaci√≥n se realizar√° en el flujo. Puedes cerrar esta ventana.");
      elClave.value = "";
      elClave.focus();
    }catch(e){
      showMsg("<strong>Error de conexi√≥n.</strong> Revisa se√±al e intenta nuevamente.");
    }finally{
      setBusy(false);
    }
  }

  // Modal cierre
  function openCloseModal(){
    if(!locationId || locationId === "DESCONOCIDO"){
      showMsg("<strong>Error.</strong> Falta el par√°metro de agencia en la URL (ej: ?loc=6).");
      return;
    }
    modalText.innerHTML = `Vas a registrar el <strong>CIERRE</strong> de la agencia <strong>${locationId}</strong>. ¬øConfirmas?`;
    modalBack.style.display = "flex";
  }
  function closeModal(){ modalBack.style.display = "none"; }

  btnOpen.addEventListener("click", () => sendAction("OPEN"));
  btnClose.addEventListener("click", openCloseModal);
  btnCancel.addEventListener("click", closeModal);
  btnConfirm.addEventListener("click", async () => { closeModal(); await sendAction("CLOSE"); });

  // Enter = Apertura (r√°pido)
  elClave.addEventListener("keydown", (e) => { if(e.key === "Enter") sendAction("OPEN"); });

  // reloj
  function tick(){
    const d = new Date();
    const hh = String(d.getHours()).padStart(2,"0");
    const mm = String(d.getMinutes()).padStart(2,"0");
    elTime.textContent = `${hh}:${mm}`;
  }
  tick();
  setInterval(tick, 15000);

  // ESC cierra modal
  document.addEventListener("keydown", (e) => { if(e.key === "Escape") closeModal(); });
  modalBack.addEventListener("click", (e) => { if(e.target === modalBack) closeModal(); });
</script>
</body>
</html>